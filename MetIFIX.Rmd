---
title: "IFIX - Metodologia de Ponderação e Rebalanceamento"
author:
date: "2023-02-10" 
output: 
  pdf_document:

    number_sections: yes
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
---

```{r, echo=T, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}

library(readxl)
library(rb3)
library(dplyr)
library(ggplot2)
library(tibble)
library(scales)

```

O objetivo do IFIX é ser o indicador de desempenho médio das cotações dos fundos imobiliários negociados nos mercados de bolsa e balcão organizado da B3.

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}

top_weight <- function(.data, n = 10) {
  top_10 <- .data |>
    arrange(desc(weight)) |>
    dplyr::slice_head(n = n) |>
    dplyr::select(symbol, weight)
  total_weight <- sum(top_10$weight)
  others <- tibble(
    symbol = "Others",
    weight = 1 - total_weight
  )
  
  tidyjson::bind_rows(top_10, others) |>
    mutate(cum_weight = cumsum(weight)) |>
    mutate(
      ymax = cum_weight,
      ymin = c(0, head(cum_weight, n = -1)),
      label_pos = (ymax + ymin) / 2,
      label = paste0(symbol, "\n", scales::percent(weight)),
      symbol = factor(symbol, ordered = TRUE)
    )
}

ggdonut <- function(.data, index_name) {
  ggplot(.data, aes(
    ymax = ymax, ymin = ymin,
    xmax = 4, xmin = 3,
    fill = symbol
  )) +
    geom_rect(colour = "grey") +
    geom_label(
      x = 4.5, aes(y = label_pos, label = label), size = 3, colour = 'black'
    ) +
    annotate(
      "text",
      x = 0, y = 0, label = index_name, size = 16, colour = "grey",
      fontface = 2
    ) +
    coord_polar(theta = "y") +
    scale_fill_brewer(palette = "Set3") +
    scale_color_brewer(palette = "Set3") +
    xlim(c(0, 4)) +
    theme_void() +
    theme(legend.position = "none") +
    labs(
      caption = "Source: B3 | Data imported at 2023-02-10"
    )
}

index_name = 'IFIX'

 index_weights_get(index_name) |>
    top_weight() |>
    ggdonut(index_name)

```

Serão selecionados para compor a carteira teórica do IFIX os fundos imobiliários que, considerando a lista de fundos imobiliários dispostos em ordem decrescente por Índice de Negociabilidade (IN) das três últimas carteiras teóricas do IFIX, estiverem contidos dentro do grupo de fundos cujos índices de Negociabilidade correspondam a 95% da soma dos índices de Negociabilidade de todos os fundos considerados.Também é uma exigência que o Fundo tenha presença em 95% dos pregões no período de vigência das três carteiras anteriores.O fundo Imobiliário também não deve ser classificado como Penny Stock.Um fundo que tenha sido objeto de Oferta Pública Inicial dentro do período de vigência das três carteiras anteriores pode ser elegível a composição do Índice, desde que o IPO tenha sido realizado antes do rebalanceamento anterior.

A participação de um determinado fundo no índice será feita com base no valor de mercado do total das cotas emitidas pelo fundo.Vale ressaltar que a participação de um determinado fundo no Índice não poderá ser superior a 20% da composição do Índice, seja no momento de sua inclusão ou em reuniões de revisões periódicas.Caso isso ocorra, serão feitos ajustes para readequar sua posição a esse limite, redistribuindo o seu excesso de participação proporcionalmente aos demais fundos do Índice. 

```{r, echo=T, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}

categorias_ifix = read_excel('C:/Users/Arthur/Downloads/Fundamentos FIIs.xlsx', 
                                     sheet = 'Dados ClubeFII')%>%
  as.data.frame()%>%
  dplyr::rename(symbol = ticker)

top_weight <- function(.data, n = 10) {
  top_10 <- .data |>
    arrange(desc(weight)) |>
    dplyr::slice_head(n = n) |>
    dplyr::select(Segmento, weight)
  total_weight <- sum(top_10$weight)
  others <- tibble(
    Segmento = "Others",
    weight = 1 - total_weight
  )
  
  tidyjson::bind_rows(top_10, others) |>
    mutate(cum_weight = cumsum(weight)) |>
    mutate(
      ymax = cum_weight,
      ymin = c(0, head(cum_weight, n = -1)),
      label_pos = (ymax + ymin) / 2,
      label = paste0(Segmento, "\n", scales::percent(weight)),
      symbol = factor(Segmento, ordered = TRUE)
    )
}

ggdonut <- function(.data, index_name) {
  ggplot(.data, aes(
    ymax = ymax, ymin = ymin,
    xmax = 4, xmin = 3,
    fill = Segmento
  )) +
    geom_rect(colour = "grey") +
    geom_label(
      x = 4.5, aes(y = label_pos, label = label), size = 1.7, colour = 'black'
    ) +
    annotate(
      "text",
      x = 0, y = 0, label = index_name, size = 16, colour = "grey",
      fontface = 2
    ) +
    coord_polar(theta = "y") +
    scale_fill_brewer(palette = "Set3") +
    scale_color_brewer(palette = "Set3") +
    xlim(c(0, 4)) +
    theme_void() +
    theme(legend.position = "none") +
    labs(
      caption = "Source: B3 | Data imported at 2023-02-10"
    )
}

rb3::index_weights_get(index_name)%>%
  dplyr::inner_join(categorias_ifix, by = 'symbol')%>%
  dplyr::select(Segmento, weight)%>%
  dplyr::group_by(Segmento)%>%
  summarise(weight = sum(weight), n = n())%>%
  top_weight()%>%
  ggdonut(index_name)

```

A categoria de maior participação do IFIX é a de Recebíveis Imobiliários (44,3%), seguido por Logisticos (17,05%), Fundos Híbridos (11,16%), Lajes Comerciais (8,33%), Shopping/Varejo (7,36%), Fundos de Fundos (7,07%), Agronegócio (1,99%), Agências Bancárias (1,24%), Incorporação Residencial (1,35%), Hospitais (0,2%) e Outros (0,91%)


