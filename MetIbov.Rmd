---
title: "Ibovespa - Metodologia de Composição e Rebalanceamento"
author: "Área de Risco"
date: "2023-02-02" 
output: 
  pdf_document:
    
    number_sections: true
    
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
---
```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}

library(readxl)
library(rb3)
library(dplyr)
library(ggplot2)
library(tibble)
library(scales)

```


```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}

top_weight <- function(.data, n = 10) {
  top_10 <- .data |>
    arrange(desc(weight)) |>
    dplyr::slice_head(n = n) |>
    dplyr::select(symbol, weight)
  total_weight <- sum(top_10$weight)
  others <- tibble(
    symbol = "Others",
    weight = 1 - total_weight
  )
  
  tidyjson::bind_rows(top_10, others) |>
    mutate(cum_weight = cumsum(weight)) |>
    mutate(
      ymax = cum_weight,
      ymin = c(0, head(cum_weight, n = -1)),
      label_pos = (ymax + ymin) / 2,
      label = paste0(symbol, "\n", scales::percent(weight)),
      symbol = factor(symbol, ordered = TRUE)
    )
}

ggdonut <- function(.data, index_name) {
  ggplot(.data, aes(
    ymax = ymax, ymin = ymin,
    xmax = 4, xmin = 3,
    fill = symbol
  )) +
    geom_rect(colour = "grey") +
    geom_label(
      x = 4.5, aes(y = label_pos, label = label), size = 3, colour = 'black'
    ) +
    annotate(
      "text",
      x = 0, y = 0, label = index_name, size = 16, colour = "grey",
      fontface = 2
    ) +
    coord_polar(theta = "y") +
    scale_fill_brewer(palette = "Set3") +
    scale_color_brewer(palette = "Set3") +
    xlim(c(0, 4)) +
    theme_void() +
    theme(legend.position = "none") +
    labs(
      caption = paste("Source: B3 | Data imported at",Sys.Date())
    )
}

index_name = 'IBOV'

 index_weights_get(index_name) |>
    top_weight() |>
    ggdonut(index_name)

```

O objetivo do Ibovespa é ser o indicador do desempenho médio das cotações dos ativos de maior negociabilidade e representatividade do mercado de ações brasileiro.Não estão inclusos no Índice BDR's e ativos em recuperação judicial ou extrajudicial.Para que um ativo permaneça no Índice após uma revisão periódica, ele deve compor o conjunto de ativos que se situam dentro do percentil de 85% dos ativos que apresentam o maior Índice de Negociabilidade (IN), em ordem decresente.Também é exigido que o ativo, considerando as últimas três carteiras teóricas, ter presença em 95% dos pregões ocorridos.Um ativo que tenha sido objeto de Oferta Pública poderá ser elegível a composição do Índice, desde que seu IPO tenha ocorrido antes do rebalanceamento imediatamente anterior.

A ponderação de uma determinada empresa no Índice Ibovespa é feita a partir do valor de mercado da parcela das ações da empresa que se encontram em free-float, com um limite de participação equivalente a duas vezes a participação que a empresa teria caso a ponderação fosse feita a partir da participação de seu Índice de Negociação (IN) no Total dos Índices de Negociação.Ou seja, o peso de uma empresa no Índice não poderá crescer para sempre caso não seja muito negociada (baixa liquidez).Caso isso ocorra, serão feitos ajustes para readequar a sua participação ao seu limite e redistribuir seu excesso de participação proporcionalmente aos demais ativos do Índice.Ressalta-se também que a participação do valor de mercado do total das ações de uma determinada empresa (considerando Ordinárias, Preferenciais e Units) não poderá ultrapassar 20% da composição do Índice.Caso isso ocorra, seu excesso de participação será redistribuído proporcionalmente para os demais ativos da carteira (isso vale como critério tanto para ingresso no índice quanto para permanência após as revisões periódicas).

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}
top_weight <- function(.data, n = 10) {
  top_10 <- .data |>
    arrange(desc(weight)) |>
    dplyr::slice_head(n = n) |>
    dplyr::select(setor, weight)
  total_weight <- sum(top_10$weight)
  others <- tibble(
    setor = "Others",
    weight = 1 - total_weight
  )
  
  tidyjson::bind_rows(top_10, others) |>
    mutate(cum_weight = cumsum(weight)) |>
    mutate(
      ymax = cum_weight,
      ymin = c(0, head(cum_weight, n = -1)),
      label_pos = (ymax + ymin) / 2,
      label = paste0(setor, "\n", scales::percent(weight)),
      symbol = factor(setor, ordered = TRUE)
    )
}

ggdonut <- function(.data, index_name) {
  ggplot(.data, aes(
    ymax = ymax, ymin = ymin,
    xmax = 4, xmin = 3,
    fill = setor
  )) +
    geom_rect(colour = "grey") +
    geom_label(
      x = 4.5, aes(y = label_pos, label = label), size = 3, colour = 'black'
    ) +
    annotate(
      "text",
      x = 0, y = 0, label = index_name, size = 16, colour = "grey",
      fontface = 2
    ) +
    coord_polar(theta = "y") +
    scale_fill_brewer(palette = "Set3") +
    scale_color_brewer(palette = "Set3") +
    xlim(c(0, 4)) +
    theme_void() +
    theme(legend.position = "none") +
    labs(
      caption = paste("Source: B3 | Data imported at",Sys.Date())
    )
}
setores = readxl::read_xlsx(
  'C:/Users/Arthur/Desktop/Setores das Empresas do IDAIPCA.xlsx')

rb3::index_weights_get('IBOV')%>%
  dplyr::mutate(ticker = substr(symbol, 1, 4))%>%
  dplyr::inner_join(setores, by = 'ticker')%>%
  dplyr::rename(setor = `Setor Econômico`)%>%
  dplyr::select(setor, weight)%>%
  dplyr::group_by(setor)%>%
  summarise(weight = sum(weight), n = n())%>%
  top_weight()%>%
  ggdonut(index_name)

```

Grande parte da composição do índice representa empresas inseridas nos setores econômicos Financeiro, Materiais Básicos, 'Petróleo, Gás e Combustíveis' e Utilidade Pública.

```{r, echo=F, eval=T, results='asis', fig.width=8, fig.height=4, fig.align='center', out.width="1\\linewidth", warning=FALSE, message=FALSE, size='small'}

ibov = quantmod::getSymbols('^BVSP', from = '2010-01-01', to = '2023-01-31', 
                            verbose = F, 
                            auto.assign = F, 
                            warnings = F)%>%
  as.data.frame()%>%
  tibble::rownames_to_column(var = 'Date')%>%
  dplyr::select(Date, BVSP.Adjusted)
itau = quantmod::getSymbols('ITUB4.SA', from = '2010-01-01', to = '2023-01-31', 
                            verbose = F, 
                            auto.assign = F, 
                            warnings = F)%>%
  as.data.frame()%>%
  dplyr::select(ITUB4.SA.Adjusted)
bbdc = quantmod::getSymbols('BBDC4.SA', from = '2010-01-01', to = '2023-01-31', 
                            verbose = F, 
                            auto.assign = F, 
                            warnings = F)%>%
  as.data.frame()%>%
  dplyr::select(BBDC4.SA.Adjusted)
vale = quantmod::getSymbols('VALE3.SA', from = '2010-01-01', to = '2023-01-31', 
                            verbose = F, 
                            auto.assign = F, 
                            warnings = F)%>%
  as.data.frame()%>%
  dplyr::select(VALE3.SA.Adjusted)
petr = quantmod::getSymbols('PETR4.SA', from = '2010-01-01', to = '2023-01-31', 
                            verbose = F, 
                            auto.assign = F, 
                            warnings = F)%>%
  as.data.frame()%>%
  dplyr::select(PETR4.SA.Adjusted)

dados = cbind(ibov, itau, bbdc, vale, petr)%>%
  dplyr::rename(
    ibov = BVSP.Adjusted,
    itau = ITUB4.SA.Adjusted,
    bbdc = BBDC4.SA.Adjusted,
    vale = VALE3.SA.Adjusted,
    petr = PETR4.SA.Adjusted)%>%
  dplyr::mutate(ibov_indice = ibov / ibov[1],
                itau_indice = itau / itau[1],
                bbdc_indice = bbdc / bbdc[1],
                vale_indice = vale / vale[1],
                petr_indice = petr / petr[1])

dados$Date = as.Date(dados$Date)

dados%>%
  ggplot(aes(x = Date))+
  geom_line(mapping = aes(y = ibov_indice, colour = 'Ibovespa'))+
  geom_line(mapping = aes(y = itau_indice, colour = 'ITUB4'))+
  geom_line(mapping = aes(y = bbdc_indice, colour = 'BBDC4'))+
  geom_line(mapping = aes(y = vale_indice, colour = 'VALE3'))+
  geom_line(mapping = aes(y = petr_indice, colour = 'PETR4'))+
  scale_x_date(breaks = date_breaks('1 year'), labels = date_format('%Y'))+
  theme(axis.text.x = element_text(angle = 45, hjust = 1))+
  labs(title = 'Ibovespa vs Maiores Empresas do índice', 
       subtitle = 'Valores em número-índice',
       x = '', y = '', caption = 'Fonte: Yahoo Finance')

```


